<!DOCTYPE html>
<!-- <html manifest='/webapp.appcache'> -->
<html>
<head>
  <title>sutsis: ze'i vlasisku</title>
  <meta name="viewport" content="initial-scale=1.0,width=device-width,user-scalable=0" />
  <link rel='stylesheet' href='http://fonts.googleapis.com/css?family=Lato%3A300%2C400%2C700%2C900%2C300italic%2C400italic%2C700italic'>
  <style type="text/css">
    .container .credit {
      margin: 20px 0;
    }

    body {
      font-family: Lato, sans-serif;
    }

    h4 {
      display: inline;
      margin: 0;
    }
    .type {
      display: inline;
      font-style: italic;
      margin-left: 25px;
      color: rgb(118, 118, 118);
      font-size: 12px;
    }
    .definition {
      margin-top: 10px;
      margin-bottom: 10px;
    }
    .term {
      padding-top: 12px;
      padding-bottom: 9px;
      border-bottom-color: rgba(0, 0, 0, 0.0980392);
      border-bottom-style: solid;
      border-bottom-width: 1px;
    }
    .rafsi {
      margin-top: 8px;
      font-size: 90%;
    }
    .rafsi span {
      font-style: italic;
      margin-left: 15px;
    }

    .bug-tracker {
      float:right;
    }

    .core-header {
      height: 48px;
      font-size: 18px;
      padding: 0 10px;
      background-color: #000;
      color: #FFF;
    }

    ::selection {
      background: #24890d;
      color: #fff;
      text-shadow: none;
    }
    .site-title {
      font-size: 18px;
      font-weight: bold;
    }
    .content {
      padding-left: 5px;
      padding-right: 5px;
    }
    #content-panel, #header-wrapper {
      max-width: 700px;
    }
    a {
      color: rgb(36, 137, 13);
      text-decoration: none;
    }
    #description {
      margin-top: 50px;
      text-align: center;
      max-width: 473px;

      text-shadow: 0px 1px 0px rgba(255,255,255,.5);
      color: #333;
    }
    #loading {
      text-align: center;
    }
    sup, sub {
     vertical-align: baseline;
     position: relative;
     top: -0.4em;
     font-size:70%;
    }
    sub { top: 0.4em; }
  </style>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script src='/components/platform/platform.js'></script>
  <link rel='import' href='/components/core-header-panel/core-header-panel.html'>
</head>
<body fullbleed layout vertical>
  <core-header-panel mode='seamed' flex>
    <div class='core-header' layout horizontal center-justified>
      <div id='header-wrapper' flex layout horizontal center>
        <span class='site-title'>sutsis</span>
        <div flex></div>
        <input id='typehere' type='text' autofocus></input>
      </div>
    </div>

    <div class='content' layout horizontal center-justified>
      <div id='content-panel'>
        <div id='description'>
          <p>
            sutsis is a lightning-fast dictionary for the lojban language.
          <p>
            The entire dictionary is loaded into your browser, making it
            fast, private, and as a bonus â€“ it works offline.
        </div>
        <div id='output'></div>

        <div id='loading'>Loading...</div>
      </div>
    </div>
  </core-header-panel>

  <div id="footer" style='display: none;'>
    <div class="container">
      <p class="bug-tracker muted credit">Please file any issues <a href='https://github.com/rictic/sutsis/issues'>here</a></p>
      <p class="muted credit">View source on github: <a href="http://github.com/rictic/sutsis">rictic/sutsis</a>.</p>
    </div>
  </div>
  <script src='/lib/jquery.js'></script>
  <script>
    var limit;
    var typehere = $("#typehere");
    var output = $("#output");
    var description = $("#description");
    var worker = new Worker('/worker.js');
    var resultCount;
    var results = [];
    var ready = false;
    worker.onmessage = function(ev) {
      if (!ev.data) {
        console.error(ev);
        throw new Error("got bad data from worker: " + JSON.stringify(ev.data))
      }
      if (ev.data.kind == 'ready') {
        engineReady();
      } else if (ev.data.kind == 'searchResults') {
        if (ev.data.query !== typehere.val()) {
          return;
        }
        results = ev.data.results;
        displayResults();
      }
    };

    function engineReady(arg) {
      ready = true;
      $("#loading").remove();
      $("#search").show();
      doSearch();
    }

    function checkScrolledNearBottom(ev) {
      var target = ev.detail.target;
      var windowBottom = target.scrollTop + window.innerHeight;
      var outputBottom = output.height() - 700;
      var isClose = windowBottom >= outputBottom;
      if(isClose) {
        limit += 10;
        displayResults();
      }
    }
    document.querySelector('core-header-panel').addEventListener('scroll', checkScrolledNearBottom)
    output.scroll();

    function lojTemplate(s) {
      s = s.replace(/\$.*?\$/g, function(c) {
        c = c.substring(1, c.length-1);
        return c.replace(/(\w)_\{?(\d+)\}?/g, "$1<sub>$2</sub>")
      });
      s = s.replace(/\{(.*?)\}/g, function(c) {
        var c = c.substring(1, c.length-1);
        return '<a href="/search/' + encodeURIComponent(c) + '">' + c + "</a>"
      });
      return s;
    }

    function displayDocument(def) {
      var out = $("<div>").addClass('term');
      out.append($("<heading layout flex horizontal end>")
          .append($("<h4>").text(def.word + ' '))
          .append($("<div flex>"))
          .append($("<div>").addClass('type').text(def.type + ' '))
      );
      if (def.definition) {
        $("<div>").addClass('definition').html(lojTemplate(def.definition) + ' ').appendTo(out);
      } else {
        var subDefs = $("<div>").addClass('definition').addClass('subdefinitions');
        for (var i = 0; i < def.rafsiDocuments.length; i++) {
          displayDocument(def.rafsiDocuments[i]).appendTo(subDefs);
        }
        subDefs.appendTo(out);
      }


      if (def.notes) {
        out.append($('<div>').addClass('notes').html(lojTemplate(def.notes) + ' '));
      }

      if (def.rafsi && def.rafsi.length > 0) {
        var rafsi = $("<div>").addClass('rafsi');
        rafsi.append("rafsi: ");
        for (var i = 0; i < def.rafsi.length; i++) {
          var rafElem = $("<span>").appendTo(rafsi);
          var raf = def.rafsi[i];
          if (def.type.match(/lujvo/)) {
            rafElem.append($("<a>").attr('href', '/search/' + encodeURIComponent(raf)).text(raf));
          } else {
            rafElem.text(raf);
          }
          rafElem.append(' ');
        }
        rafsi.appendTo(out);
      }
      out.find('a').click(function(el) {
        if (el.ctrlKey || el.metaKey) { // let the user open in new tabs
          return;
        }
        window.history.pushState({}, null, $(el.target).attr('href'));
        handleUrl();
        return false;
      });
      return out;
    }

    var searchIdCounter = 0;
    var prevQuery;
    var lastQueried = now();
    function doSearch() {
      var query = typehere.val();
      if (query === prevQuery) {
        return;
      }
      prevQuery = query;
      updateUrl(query);

      var searchId = ++searchIdCounter;
      output.empty();
      if (query.trim() == '') {
        output.hide();
        description.show();
        return;
      } else {
        description.hide();
        output.show();
      }
      limit = 50;
      resultCount = 0;
      worker.postMessage({kind: 'newSearch', 'query': query, 'searchId': searchId});
    }
    typehere.keyup(doSearch);

    function updateUrl(query) {
      var url = '/';
      if (query.length > 0) {
        url = '/search/' + query
      }
      if (url == window.location.pathname) {
        return;
      }
      var difference = now() - lastQueried;
      if (difference > 2000) {
        window.history.pushState({}, null, url);
      } else {
        window.history.replaceState({}, null, url);
      }
      lastQueried = now();
    }
    function handleUrl() {
      var searchMatch = window.location.pathname.match(/\/search\/(.*)/);
      query = '';
      if (searchMatch) {
        var query = decodeURIComponent(searchMatch[1]);
      }
      typehere.val(query);
      if (ready) {
        doSearch();
      }
    }
    handleUrl();
    window.addEventListener('popstate', handleUrl);
    $(document.body).keyup(function(ev) {
      if (ev.keyCode === 191) {  // The '/' character
        typehere.focus();
      }
    })

    function displayResults() {
      var displayUpTo = Math.min(limit, results.length);
      for (; resultCount < displayUpTo; resultCount++) {
        displayDocument(results[resultCount]).appendTo(output);
      }
    }

    function now() {
      if (window.performance) {
        if (performance.now) {
          return performance.now();
        }
      }
      return +new Date();
    }
  </script>
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-39779012-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
</body>
</html>
