<html>
<head>
  <title>sutyvlaste: ze'i jbovlaste</title>
  <link rel="stylesheet" type="text/css" href="lib/bootstrap/css/bootstrap.min.css">
  <style type="text/css">
    body {
      padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
    }

    h4 {
      display: inline;
    }
    .type {
      display: inline;
      font-style: italic;
      margin-left: 25px;
    }
    .definition {
      margin-top: 15px;
    }
    .term {
      margin: 30px;
    }
    #typehere {
      display: none;
    }
  </style>
</head>
<body>
  <div class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
      <div class="container">
        <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="brand" href="#">sutyvlaste</a>
      </div>
    </div>
  </div>

    <div class="container">

      <div id='main'>
        <h1>Search:</h1>
        <div id='loading'>
          <img src="data/loading.gif">
        </div>
        <input id="typehere" autofocus></input>

        <div id='output'></div>
      </div>

    </div> <!-- /container -->


  <script src='lib/jquery.js'></script>

  <script type="text/javascript" src="lib/fullproof/unicode/categ_letters_numbers.js"></script>
  <script type="text/javascript" src="lib/fullproof/unicode/normalizer_lowercase_nomark.js"></script>
  <script type="text/javascript" src="lib/fullproof/unicode/unicode.js"></script>
  <script type="text/javascript" src="lib/fullproof/analyzers.js"></script>
  <script type="text/javascript" src="lib/fullproof/normalizers.js"></script>
  <script type="text/javascript" src="lib/fullproof/misc/dataloader.js"></script>
  <script type="text/javascript" src="lib/fullproof/capabilities.js"></script>
  <script type="text/javascript" src="lib/fullproof/utils.js"></script>
  <script type="text/javascript" src="lib/fullproof/common-engine.js"></script>
  <script type="text/javascript" src="lib/fullproof/boolean-engine.js"></script>
  <script type="text/javascript" src="lib/fullproof/resultsets.js"></script>
  <script type="text/javascript" src="lib/fullproof/storemanager.js"></script>
  <script type="text/javascript" src="lib/fullproof/stores/memory_store.js"></script>

  <script>
    var literals = {};
    var documentStore = {};
    $.ajax({url:"data/lojban-export.xml", dataType:'xml'}).then(function(doc) {
      if (doc == null) {return;}
      var dictionary = doc.childNodes[0];
      var eToL = dictionary.childNodes[2];
      var words = eToL.childNodes;
      for (var i = 1; i < words.length; i++) {
        var nlword = $(eToL.childNodes[i]);
        var terms = [nlword.attr('word')];
        while (terms.length > 0) {
          var term = terms.pop();
          if (!(term in literals)) {
            literals[term] = [];
          }
          literals[term].push(nlword.attr('valsi'));
        }
      }
      var lToE = dictionary.childNodes[1];
      var words = lToE.childNodes;
      for (var i = 1; i < words.length; i++) {
        var valsi = $(words[i]);
        var term = valsi.attr("word")
        if (!term) {
          continue;
        }
        var type = valsi.attr("type")
        var definition = valsi.find('definition').text();
        documentStore[term] = {
            word: term,
            type: type,
            definition: definition
        };
      }
      setupSearchEngine();
    });

    var typehere = $("#typehere");
    var output = $("#output");
    var searchIdCounter = 0;
    function search() {
      var searchId = ++searchIdCounter;
      var query = typehere.val();
      var words = literals[query] || [];
      words.push(query);
      output.empty();
      if (query.length == 0) {
        return;
      }
      var set = {};
      for (var i = 0; i < words.length; i++) {
        set[words[i]] = true;
        var doc = documentStore[words[i]];
        if (!doc) {
          continue;
        }
        displayDocument(doc);
      }
      searchEngine.lookup(query, function(results) {
        if (searchId !== searchIdCounter) {
          return;
        }
        if (results) {
          results.forEach(function(key) {
            if (key in set) {
              return;
            }
            displayDocument(documentStore[key]);
          });
        }
      });
    }

    function displayDocument(def) {
      var out = $("<div>").addClass('term');
      out.append($("<heading>")
          .append($("<h4>").text(def.word))
          .append($("<div>").addClass('type').text(def.type))
      );
      var defElem = $("<div>").addClass('definition');

      var definition = def.definition;
      var vals = definition.split("$");
      for (var i = 0; i < vals.length; i++) {
        if (i % 2 === 0) {
          defElem.append($("<span>").text(vals[i]));
          continue;
        }
        var latec = vals[i];

        latec = latec.replace(/(.)_\{?(\d+)\}?/g, "$1<sub>$2</sub>");
        defElem.append($("<i>").html(latec));
      }
      defElem.appendTo(out);
      out.appendTo(output);
    }

    typehere.keyup(search);

    var searchEngine;
    function setupSearchEngine() {
      var dbName = "sutyvlaste";
      searchEngine = new fullproof.BooleanEngine();
      var indexes = [{
          name: "normalindex",
          analyzer: new fullproof.StandardAnalyzer(
              fullproof.normalizer.to_lowercase_nomark),
          capabilities: new fullproof.Capabilities().setUseScores(
              false).setDbName(dbName),
          initializer: initializer
      }];
      searchEngine.open(indexes, fullproof.make_callback(engineReady, true), fullproof.make_callback(engineReady, false));
    }

    function initializer(injector, callback) {
      var numTerms = objectSize(documentStore);
      var synchro = fullproof.make_synchro_point(callback, numTerms);

      for (var key in documentStore) {
        var doc = documentStore[key];
        var text = doc.type + ' ' + doc.definition;
        injector.inject(text, key, synchro);
      }
    }

    function engineReady(arg) {
      if (arg) {
        $("#loading").remove();
        $("#typehere").show();
      }
    }

    function objectSize(obj) {
      var i = 0;
      for (var key in obj) i++;
      return i;
    }
  </script>
</body>
</html>
