<html>
<head>
  <title>sutyvlaste: ze'i jbovlaste</title>
  <link rel="stylesheet" type="text/css" href="lib/bootstrap/css/bootstrap.min.css">
  <style type="text/css">
    body {
      padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
    }

    h4 {
      display: inline;
    }
    .type {
      display: inline;
      font-style: italic;
      margin-left: 25px;
    }
    .definition {
      margin-top: 15px;
    }
    .term {
      margin: 30px;
    }

  </style>
</head>
<body>
  <div class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
      <div class="container">
        <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="brand" href="#">sutyvlaste</a>
      </div>
    </div>
  </div>

    <div class="container">

      <h1>Search:</h1>
        <input id="typehere" autofocus></input>

        <div id='output'>

        </div>


    </div> <!-- /container -->


  <script src='lib/jquery.js'></script>
  <script>
    var literals = {};
    var documentStore = {};
    $.ajax({url:"data/lojban-export.xml", dataType:'xml'}).then(function(doc) {
      if (doc == null) {return;}
      var dictionary = doc.childNodes[0];
      var eToL = dictionary.childNodes[2];
      var words = eToL.childNodes;
      for (var i = 1; i < words.length; i++) {
        var nlword = $(eToL.childNodes[i]);
        var terms = [nlword.attr('word')];
        while (terms.length > 0) {
          var term = terms.pop();
          if (!(term in literals)) {
            literals[term] = [];
          }
          if (term == 'ba') {
            debugger
          }
          literals[term].push(nlword.attr('valsi'));
        }
      }
      var lToE = dictionary.childNodes[1];
      var words = lToE.childNodes;
      for (var i = 1; i < words.length; i++) {
        var valsi = $(words[i]);
        var term = valsi.attr("word")
        if (!term) {
          continue;
        }
        var type = valsi.attr("type")
        var definition = valsi.find('definition').text();
        if (!(term in documentStore)) {
          documentStore[term] = [];
        } else {
          debugger;
        }
        documentStore[term].push({
          word: term,
          type: type,
          definition: definition
        });
      }
      search();
    });

    var typehere = $("#typehere");
    var output = $("#output");
    function search() {
      var query = typehere.val();
      var words = literals[query] || [];
      words.push(query);
      output.empty();
      for (var i = 0; i < words.length; i++) {
        var documents = documentStore[words[i]];
        if (!documents) {
          continue;
        }
        for (var j = 0; j < documents.length; j++) {
          displayDocument(documents[j]);
        }
      }
    }

    function displayDocument(def) {
      var out = $("<div>").addClass('term');
      out.append($("<heading>")
          .append($("<h4>").text(def.word))
          .append($("<div>").addClass('type').text(def.type))
      );
      var defElem = $("<div>").addClass('definition');

      var definition = def.definition;
      var vals = definition.split("$");
      // debugger
      for (var i = 0; i < vals.length; i++) {
        if (i % 2 === 0) {
          defElem.append($("<span>").text(vals[i]));
          continue;
        }
        var latec = vals[i];

        latec = latec.replace(/(.)_\{?(\d+)\}?/g, "$1<sub>$2</sub>");
        defElem.append($("<i>").html(latec));
      }
      defElem.appendTo(out);
      out.appendTo(output);
    }

    typehere.keyup(search);
  </script>
</body>
</html>
