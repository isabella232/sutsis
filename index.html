<html>
<head>
  <title>sutyvlaste: ze'i jbovlaste</title>
  <link rel="stylesheet" type="text/css" href="lib/bootstrap/css/bootstrap.min.css">
  <style type="text/css">
    /* Sticky footer styles
    -------------------------------------------------- */

    html,
    body {
      height: 100%;
      /* The html and body elements cannot have any padding or margin. */
    }

    /* Wrapper for page content to push down footer */
    #wrap {
      min-height: 100%;
      height: auto !important;
      height: 100%;
      /* Negative indent footer by it's height */
      margin: 0 auto -60px;
    }

    /* Set the fixed height of the footer here */
    #push,
    #footer {
      height: 60px;
    }
    #footer {
      background-color: #f5f5f5;
    }

    /* Lastly, apply responsive CSS fixes as necessary */
    @media (max-width: 767px) {
      #footer {
        margin-left: -20px;
        margin-right: -20px;
        padding-left: 20px;
        padding-right: 20px;
      }
    }



    /* Custom page CSS
    -------------------------------------------------- */
    /* Not required for template or sticky footer method. */

    .container {
      width: auto;
      max-width: 680px;
    }
    .container .credit {
      margin: 20px 0;
    }




    h4 {
      display: inline;
    }
    .type {
      display: inline;
      font-style: italic;
      margin-left: 25px;
    }
    .definition {
      margin-top: 10px;
      margin-bottom: 10px;
    }
    .term {
      margin: 30px;
    }
    #search {
      display: none;
    }
    .rafsi {
      font-size: 90%;
    }
    .rafsi span {
      font-style: italic;
      margin-left: 15px;
    }
    .right-header {
      float: right;
      margin-top: 14px;
    }
    #typehere {
      height: 30px;
      width: 206px;
    }
  </style>
</head>
<body>

    <!-- Part 1: Wrap all page content here -->
    <div id="wrap">

      <!-- Begin page content -->
      <div class="container">
        <div class="page-header">
          <div class='right-header'>
            <div id='loading'>
              <img src="data/loading.gif">
            </div>
            <div id='search'>

              <div class="control-group">
                <div class="controls">
                  <div class="input-prepend">
                    <span class="add-on"><i class="icon-search"></i></span>
                    <input class="span2" id="typehere" type="text" autofocus>
                  </div>
                </div>
              </div>
<!--               <div class="controls">
                <div class="input-prepend">
                  <span class="add-on"><i class="icon-search"></i></span>
                  <input id="typehere" autofocus></input>
                </div>
              </div> -->
            </div>
          </div>

          <h1>sutyvlaste</h1>

        </div>

        <div id='output'></div>

      </div>

      <div id="push"></div>
    </div>

    <div id="footer">
      <div class="container">
        <p class="muted credit">View source on github: <a href="http://github.com/rictic/sutyvlaste">rictic/sutyvlaste</a>.</p>
      </div>
    </div>

    </div> <!-- /container -->


  <script src='lib/jquery.js'></script>

  <script type="text/javascript" src="lib/fullproof/unicode/categ_letters_numbers.js"></script>
  <script type="text/javascript" src="lib/fullproof/unicode/normalizer_lowercase_nomark.js"></script>
  <script type="text/javascript" src="lib/fullproof/unicode/unicode.js"></script>
  <script type="text/javascript" src="lib/fullproof/analyzers.js"></script>
  <script type="text/javascript" src="lib/fullproof/normalizers.js"></script>
  <script type="text/javascript" src="lib/fullproof/misc/dataloader.js"></script>
  <script type="text/javascript" src="lib/fullproof/capabilities.js"></script>
  <script type="text/javascript" src="lib/fullproof/utils.js"></script>
  <script type="text/javascript" src="lib/fullproof/common-engine.js"></script>
  <script type="text/javascript" src="lib/fullproof/boolean-engine.js"></script>
  <script type="text/javascript" src="lib/fullproof/resultsets.js"></script>
  <script type="text/javascript" src="lib/fullproof/storemanager.js"></script>
  <script type="text/javascript" src="lib/fullproof/stores/memory_store.js"></script>

  <script>
    var literals = {};
    var documentStore = {};

    function addLiteral(english, lojban) {
      if (!(english in literals)) {
        literals[english] = [];
      }
      literals[english].push(lojban);
    }

    $.ajax({url:"data/lojban-export.xml", dataType:'xml'}).then(function(doc) {
      if (doc == null) {return;}
      var dictionary = doc.childNodes[0];
      var eToL = dictionary.childNodes[2];
      var words = eToL.childNodes;

      for (var i = 1; i < words.length; i++) {
        var nlword = $(eToL.childNodes[i]);
        var terms = [nlword.attr('word')];
        while (terms.length > 0) {
          var term = terms.pop();
          addLiteral(term, nlword.attr('valsi'))
        }
      }
      var lToE = dictionary.childNodes[1];
      var words = lToE.childNodes;
      for (var i = 1; i < words.length; i++) {
        var valsi = $(words[i]);
        var term = valsi.attr("word")
        if (!term) {
          continue;
        }
        var type = valsi.attr("type")
        var definition = valsi.find('definition').text();
        var rafsi = [].slice.call(
          valsi.find('rafsi').map(function(_, r){
            addLiteral($(r).text(), term);
            return $(r).text();
          })
        );

        documentStore[term] = {
            word: term,
            type: type,
            definition: definition,
            rafsi: rafsi
        };
      }
      setupSearchEngine();
    });

    var typehere = $("#typehere");
    var output = $("#output");
    var searchIdCounter = 0;
    var limit;
    function search() {
      var searchId = ++searchIdCounter;
      var query = typehere.val();
      var words = (literals[query] || []).slice();
      limit = 10;
      words.push(query);

      output.empty();
      if (query.length == 0) {
        return;
      }
      var set = {};
      var resultCount = 0;

      for (var i = 0; i < words.length; i++) {
        resultCount++;
        set[words[i]] = true;
        var doc = documentStore[words[i]];
        if (!doc) {
          continue;
        }
        displayDocument(doc);
      }
      searchEngine.lookup(query, function(results) {
        if (!results) {
          return;
        }
        if (searchId !== searchIdCounter) {
          return;
        }
        var index = 0;

        displayResultsUpToLimit = function() {
          if (searchId !== searchIdCounter) {
            return;
          }
          while (resultCount < limit) {
            var key = results.getItem(index);
            index++;
            if (key in set) {
              continue;
            }
            var doc = documentStore[key];
            if (!doc) {
              break;
            }
            resultCount++;
            displayDocument(doc);
          }
        }
        checkScrolledNearBottom();
      });
    }

    function displayResultsUpToLimit() {

    }

    function checkScrolledNearBottom() {
      var windowBottom = ($(window).scrollTop() + window.innerHeight);
      var bottom = $(document).height() - 700;
      var isClose = windowBottom >= bottom;
      if(isClose) {
        limit += 10;
        displayResultsUpToLimit();
      }
    }
    $(window).scroll(checkScrolledNearBottom);

    function displayDocument(def) {
      var out = $("<div>").addClass('term');
      out.append($("<heading>")
          .append($("<h4>").text(def.word))
          .append($("<div>").addClass('type').text(def.type))
      );
      var defElem = $("<div>").addClass('definition');

      var definition = def.definition;
      var vals = definition.split("$");
      for (var i = 0; i < vals.length; i++) {
        if (i % 2 === 0) {
          defElem.append($("<span>").text(vals[i]));
          continue;
        }
        var latec = vals[i];

        latec = latec.replace(/(.)_\{?(\d+)\}?/g, "$1<sub>$2</sub>");
        defElem.append($("<i>").html(latec));
      }
      defElem.appendTo(out);

      if (def.rafsi && def.rafsi.length > 0) {
        var rafsi = $("<div>").addClass('rafsi');
        rafsi.append("rafsi: ");
        for (var i = 0; i < def.rafsi.length; i++) {
          rafsi.append($("<span>").text(def.rafsi[i] + ' '));
        }
        rafsi.appendTo(out);
      }
      out.appendTo(output);
    }

    typehere.keyup(search);

    var searchEngine;
    function setupSearchEngine() {
      var dbName = "sutyvlaste";
      searchEngine = new fullproof.BooleanEngine();
      var indexes = [{
          name: "normalindex",
          analyzer: new fullproof.StandardAnalyzer(
              fullproof.normalizer.to_lowercase_nomark),
          capabilities: new fullproof.Capabilities().setUseScores(
              false).setDbName(dbName),
          initializer: initializer
      }];
      searchEngine.open(indexes, fullproof.make_callback(engineReady, true), fullproof.make_callback(engineReady, false));
    }

    function initializer(injector, callback) {
      var numTerms = objectSize(documentStore);
      var synchro = fullproof.make_synchro_point(callback, numTerms);

      for (var key in documentStore) {
        var doc = documentStore[key];
        var text = doc.word + ' ' + doc.type + ' ' + doc.definition;
        injector.inject(text, key, synchro);
      }
    }

    function engineReady(arg) {
      if (arg) {
        $("#loading").remove();
        $("#search").show();
      }
    }

    function objectSize(obj) {
      var i = 0;
      for (var key in obj) i++;
      return i;
    }
  </script>
</body>
</html>
